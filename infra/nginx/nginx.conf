worker_processes auto;
 
events {

    worker_connections 4096;

    multi_accept on;

    use epoll;

}
 
http {

    include mime.types;

    default_type application/octet-stream;

    client_body_buffer_size 128K;

    client_max_body_size 3072M;

    client_header_buffer_size 128K;

    keepalive_timeout 30;

    sendfile on;

    tcp_nopush on;

    tcp_nodelay on;
 
    # Gzip Configuration

    gzip on;

    gzip_proxied any;

    gzip_comp_level 5;
	

    gzip_types text/plain text/css text/javascript application/javascript application/json application/xml image/svg+xml;
    add_header X-Cache $upstream_cache_status; 

    server {

        listen 80;

        server_name _;
        return 301 https://$host$request_uri;

    }
 
    server {

        listen 443 ssl;
        listen [::]:443;

        listen 443 quic reuseport;

        listen [::]:443 quic reuseport;
	autoindex on;
   
        index index.php index.html;
 
        # SSL Configuration

        # Bloqueo COMPLETO de la carpeta storage
        # location ^~ /storage/ {
        #     deny all;
        #     return 403;
        # }

        # Excepción para archivos enlazados públicamente (si usas storage:link)
        location ^~ /storage/app/public/ {
            internal;  # Solo accesible internamente
            alias /var/www/html/storage/app/public/;

            # Doble protección para archivos sensibles
            location ~* \.(php|env|log|htaccess|key)$ {
                deny all;
                return 403;
            }
        }

        # Excepción para la carpeta cursos
        location ^~ /storage/cursos/ {
            alias /var/www/html/storage/cursos/;
            autoindex off;  # Desactiva el listado de directorios
            access_log off; # Opcional: desactiva logs para estos archivos

            # Configuración de caché
            expires 30d;
            add_header Cache-Control "public";

            # Bloquea archivos sensibles incluso en la carpeta permitida
            location ~* \.(php|env|log|htaccess|key)$ {
                deny all;
                return 403;
            }
        }

        # Excepción para la carpeta empleados
        # location ^~ /storage/empleados/ {
        #     alias /var/www/html/storage/empleados/;
        #     autoindex off;  # Desactiva el listado de directorios
        #     access_log off; # Opcional: desactiva logs para estos archivos

        #     # Configuración de caché
        #     expires 30d;
        #     add_header Cache-Control "public";

        #     # Bloquea archivos sensibles incluso en la carpeta permitida
        #     location ~* \.(php|env|log|htaccess|key)$ {
        #         deny all;
        #         return 403;
        #     }
        # }

        ssl_certificate /etc/nginx/ssl/Tabantaj.crt;

        ssl_certificate_key /etc/nginx/ssl/Tabantaj.key;

        ssl_protocols TLSv1.2 TLSv1.3;

        ssl_prefer_server_ciphers on;

        ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
 
        # Security Headers
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
  
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        add_header Permissions-Policy "geolocation=(), microphone=()" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header Content-Security-Policy "upgrade-insecure-requests;" always;
	add_header X-Cache $upstream_cache_status;	
	add_header Alt-Svc 'h2:443' always;
	add_header Alt-Svc 'h3=":443"; ma=86400, h2=":443"; ma=86400' always;
	
        # PHP Handling for FrankenPHP
root /var/www/html/public;   
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;


location / {

        # HTTP/3 Support
        add_header Alt-Svc 'h3=":443"; ma=86400, h2=":443"; ma=86400' always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        add_header Permissions-Policy "geolocation=(), microphone=()" always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header Content-Security-Policy "upgrade-insecure-requests;" always;
        add_header X-Cache $upstream_cache_status;
        add_header Alt-Svc 'h2:443' always;
        add_header Alt-Svc 'h3=":443"; ma=86400, h2=":443"; ma=86400' always;


        location ~ \.php$ {
            try_files $uri $uri/ /index.php?$query_string;
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            fastcgi_pass php:9000;
            fastcgi_index index.php;
            include fastcgi_params;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param PATH_INFO $fastcgi_path_info;
            fastcgi_read_timeout 360s;
            fastcgi_buffers 32 32k;
            fastcgi_buffer_size 128k;
            fastcgi_connect_timeout 60;
            fastcgi_send_timeout 60;

 
        # Deny access to hidden files

        location ~ /\. {

            deny all;

       }
   
     }

}
 

